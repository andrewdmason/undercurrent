---
description: Core agent instructions for Undercurrent
globs: "*"
alwaysApply: true
---

# Undercurrent

A video marketing idea generator for small businesses, powered by AI.

## Tech Stack

- **Framework:** Next.js (App Router)
- **Styling:** Tailwind CSS 4.1
- **Components:** shadcn/ui
- **Database & Auth:** Supabase with email auth
- **Hosting:** Vercel
- **AI:** ChatGPT 5.1 (text), Gemini 3 Pro Image Preview (images)

## Code Conventions

- TypeScript for all code
- Follow design system in `docs/design-system.md`
- Store AI prompts as markdown in `/prompts`
- Supabase client for all database operations

## Git Workflow

- Feature branches prefixed with `andrew/`
- Don't commit to main directly

## Database Migrations (CRITICAL)

**⚠️ NEVER modify migration files from previous branches or that have been merged to main.**

Once a migration has been merged to main and potentially run on production, it is **immutable**. Modifying it will cause the changes to never run on production (since Supabase tracks which migrations have already been applied by filename).

### Migration Rules

1. **One new migration per branch maximum** - If you need schema changes, create ONE new migration file
2. **Never edit existing migrations** - If a migration file existed before your branch, DO NOT TOUCH IT
3. **Use the next timestamp** - Check existing migrations and use the next logical timestamp (e.g., if latest is `20241209000000`, use `20241210000000`)
4. **If you already created a migration in this branch** - Add new changes to that same file, don't create another one
5. **Use IF NOT EXISTS** - When possible, use `CREATE TABLE IF NOT EXISTS`, `CREATE INDEX IF NOT EXISTS`, `DROP POLICY IF EXISTS` before `CREATE POLICY` for safer migrations

### Before Creating/Editing Migrations

Ask yourself: "Did this migration file exist before I started this branch?"
- **Yes** → DO NOT EDIT IT. Create a new migration file instead.
- **No** → Safe to edit (it's your branch's migration)

## Domain Concepts

### Descript Underlord

Underlord is Descript's AI editing assistant - think of it as the video editing equivalent of Cursor. It's a "vibe-editing" chatbot where you describe what you want done and it executes like an assistant editor would. Unlike simple command-based tools, Underlord can accept long, detailed prompts including full scripts, multi-step editing instructions, and creative direction. When Undercurrent generates an "Underlord prompt," users copy/paste it into Descript to automate their video production workflow.

## Specialized Instructions

When working on specific areas, reference these additional rule files:

- **AI/LLM features** → See `.cursor/rules/ai-features.mdc` for ChatGPT integration guidelines
